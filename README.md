# avs rgr file

---

Это комплексная инфраструктура, включающая такие компоненты, как `Traefik` для маршрутизации и HTTPS, `Jenkins` для автоматизации CI/CD, и сопутствующий стек.

---

## **Принципы работы**

1. **Traefik как маршрутизатор**:
   - Traefik используется для маршрутизации HTTP/HTTPS запросов к Jenkins и другим сервисам.
   - Динамическая конфигурация `traefik_dynamic_conf.yml` определяет использование HTTPS с сертификатами.
   - Labels на сервисах управляют маршрутизацией: например, для Jenkins указано правило `Host(example.localhost) && PathPrefix(/jenkins)`.

2. **Jenkins для CI/CD**:
   - Jenkins развёрнут в контейнере с сохранением всех данных и настроек в volume `jenkins_home`.
   - Пайплайн (`Jenkinsfile`) описывает этапы автоматизации:
     - Клонирование репозитория GitHub.
     - Сборка Docker-образа приложения.
     - Удаление старого контейнера (если он существует).
     - Запуск нового контейнера с собранным приложением.
   - Jenkins взаимодействует с Docker через сокет `/var/run/docker.sock`, смонтированный из хоста.

3. **Docker Compose для оркестрации**:
   - `docker-compose.yml` описывает всю инфраструктуру, включая Jenkins и Traefik.
   - Volumes обеспечивают сохранение данных между перезапусками.

---

## **Нюансы, которые стоит учитывать**

### **Traefik**
- **Настройка HTTPS**:
  - Проверьте, что сертификаты (`example.localhost.pem` и `example.localhost-key.pem`) правильно указаны в `traefik_dynamic_conf.yml`.
  - Для боевой среды используйте Let's Encrypt или доверенные сертификаты.
- **Маршрутизация**:
  - Labels, указанные в `docker-compose.yml` для Jenkins, управляют маршрутизацией через Traefik. Убедитесь, что они корректны.

### **Jenkins**
- **Pipeline**:
  - Текущий `Jenkinsfile` уже включает стадии для клонирования репозитория, сборки Docker-образа и обновления контейнера.
  - Чтобы обеспечить автоматический запуск задачи при изменениях в репозитории:
    - Используйте Git polling в Jenkins (например, интервал проверки каждые 5 минут: `H/5 * * * *`).
    - Это позволит обойтись без webhook'ов.
- **Сохранение настроек**:
  - Все данные Jenkins сохраняются в volume `jenkins_home`, что соответствует ТЗ.
  - Убедитесь, что настройки в этом каталоге правильно бэкапятся.

### **Docker Compose**
- **Обновление контейнеров**:
  - Убедитесь, что в `Jenkinsfile` есть корректная логика остановки и удаления старого контейнера перед запуском нового:
    ```bash
    if [ $(docker ps -aq -f name=${IMAGE_NAME}) ]; then
        docker stop ${IMAGE_NAME}
        docker rm ${IMAGE_NAME}
    fi
    ```
- **Перезапуск после сбоев**:
  - В `docker-compose.yml` добавьте параметр `restart: always` для всех сервисов.

---

4. **Дополнительные проверки**:
   - Проверьте, что `docker-compose.yml` полностью соответствует вашим требованиям. Например, убедитесь, что volumes и сети настроены корректно.

---



**Чтобы запустить код из этого репозитория, следуйте этим шагам:**

---

## **1. Убедитесь, что у вас установлено:**
- **Git**: Для клонирования репозитория.
- **Docker и Docker Compose**: Для сборки и запуска контейнеров.
- **Jenkins (опционально)**: Если хотите использовать Jenkins в контейнере.

---

## **2. Клонируйте репозиторий**
Выполните команду:

```bash
git clone https://github.com/xCredo/avs.git
cd avs
```

---

## **3. Сборка и запуск приложения с помощью Docker**

### Сборка Docker-образа:
Перейдите в корневую папку и выполните:

```bash
docker build -t avs:latest .
```

### Запуск контейнера:
Запустите контейнер, пробросив порты:

```bash
docker run -d --name avs_container -p 8181:80 avs:latest
```

### Проверка работы:
Откройте браузер или выполните команду:

```bash
curl http://localhost:8181
```

Вы должны увидеть текст из программы `main.cpp`.

---

## **4. Запуск всей инфраструктуры с помощью Docker Compose**

Если вы хотите запустить всю инфраструктуру, включая Traefik и Jenkins:

### Подготовка:
Убедитесь, что файлы `infra/docker-compose.yml` и `infra/traefik_dynamic_conf.yml` настроены корректно.

### Запуск:
Перейдите в папку `infra` и выполните:

```bash
docker-compose up -d
```

### Проверка:
1. **Traefik Dashboard**:
   - Доступно по адресу: [http://localhost:8080](http://localhost:8080).

2. **Jenkins**:
   - Доступно по адресу: [https://localhost/jenkins](https://localhost/jenkins).

---

## **5. Работа с Jenkins (CI/CD)**

### Запуск пайплайна:
1. Откройте Jenkins ([https://localhost/jenkins](https://localhost/jenkins)).
2. Войдите (учётные данные по умолчанию: `admin/admin`).
3. Создайте новую задачу (pipeline).
4. Укажите в настройках ссылку на ваш репозиторий: `https://github.com/xCredo/avs.git`.
5. Сохраните и запустите.

---

